---
title: "growth curve"
output: pdf_document
header-includes:
    - \usepackage{fancyhdr}
    - \pagestyle{fancy}
toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(knitr)
library(janitor)
source(here::here("analysis/00-metadata.R"))
```

\newpage

## 1. Pilot 

Six strains used in the plant experiment. Eight replicates each.

```{r}
#pilot_plate <- tibble(
#    Well = paste0(rep(LETTERS[1:8], 12), rep(sprintf("%02d", 1:12), each = 8)),
#    Strain = c(rep(c("H2M3R1", "H3M1R1", "H4M5R1", "L2M2R1", "L3M5R1", "L4M2R2"), each = #8), rep("blank", 6*8)))

#write_csv(pilot_plate, paste0(folder_data, "raw/growth_curve/pilot_plate.csv"))
```

\newpage

## 2. Growth curve of 19 strains

- Prepare the Time

```{r}
isolates_rhizo <- read_csv(paste0(folder_data, "temp/01-isolates_rhizo.csv"), show_col_types = F)
```

```{r eval=F}
isolates_rhizo %>%
    tabyl(Site) # 8 H and 11 L
```

```{r}
isolates_rhizo %>%
    select(ExpID, ID, Family, Genus) %>%
    kable()
```

- revive glycerol stock of rhizobia on TY agar
    - prepare labelled plates
    - use a sterilized inoculation loop to streak the glycerol stock on TY agar
    - incubate the petri plates at 30C for 2-3 days until the colony is identifiably large

- prepare rhizobium inoculum
    - prepare a DW96 filled with 300uL of PBS
    - pick colonies from the petri plate and dissolve the colonies in the PBS. Use wells in column 1, 5, and 9
    - dispense 100 uL of the dissolved colony to a NUNC96 and measure od at 600 nm
    - standardize the OD600 to 0.1. For target od = 0.1 `od_target` and target inoculum volume = 300 uL `volume_target`, and given the measured od of dissolved colonies  `od_dissolved`, use the code below to calculate the needed volume of the dissolved colonies `volume_dissolved` and the pbs volume `volume_pbs`
    - prepare another DW96, follow the table to add required volume of dissolved colonies and pbs to make 300 uL of standardized inoculum
    - measure the od of the standardized inoculum as `od_inoculum`

- prepare 100 uL of TY medium in NUNC96
    - inoculate 2 uL of the standardized inoculum to each well 


```{r fig.height=3.5}
#' This code is to plot the petri plate layout
# Create a data frame for the well positions
gc_plate <- as_tibble(expand.grid(row = LETTERS[1:8], column = 1:12))
gc_plate$row <- factor(gc_plate$row, levels = rev(LETTERS[1:8]))
gc_plate$column <- factor(gc_plate$column, levels = 1:12)
gc_plate$strain <- c(
    rep(isolates_rhizo$ExpID[1:8], 4),
    rep(isolates_rhizo$ExpID[9:16], 4),
    rep(c(isolates_rhizo$ExpID[17:19], rep("blank", 5)), 4)
    )
gc_plate$well <- paste0(gc_plate$row, sprintf("%02d", gc_plate$column))

# Create a blank plot
p <- ggplot(gc_plate, aes(x = column, y = row)) +
    geom_point(aes(fill = strain), color = "black", shape = 21, size = 10) +
    geom_text(aes(label = strain), size = 2) +
    coord_equal() +
    scale_x_discrete(position = "top") +
    scale_fill_manual(values = c(RColorBrewer::brewer.pal(9, "Pastel1"), RColorBrewer::brewer.pal(11, "Set3"))) +
    theme_bw() +
    theme(
        #axis.text = element_blank(),
        axis.ticks = element_blank(),
        #panel.grid = element_blank(),
        panel.border = element_rect(color = "black", fill = NA),
        plot.margin = margin(1, 1, 1, 1)
    ) +
    guides(fill = "none") +
    labs(x = "", y = "")


write_csv(gc_plate, paste0(folder_data, "raw/growth_curve/gc_plate.csv"))
```


```{r fig.height=3.5}
p
```

Use the code below to standardize OD

```{r}
clean_well_names <- function (x) {
    y <- paste0(str_sub(x, 1, 1), str_sub(x, 2, 3) %>% as.numeric %>% sprintf("%02d", .))
    return(y)
}

wide_to_long <- function (x) {
    x %>% 
        rename(row = ...1) %>%
        pivot_longer(cols = -row, names_to = "column", values_to = "od600")
        
}

```

\newpage 

```{r message=F}
#"READ THE ACTUAL DATA HERE AS mi"
mi <- read_csv(paste0(folder_data, "raw/growth_curve/inocula_before_standardization2.csv"), show_col_types = F)
# Match well to inocula
mi_before <- mi %>%
    select(-...14) %>%
    wide_to_long() %>%
    left_join(gc_plate, by = join_by("row", "column")) %>%
    filter(column %in% c(1, 5, 9))

od600_blank <- mean(mi_before$od600[mi_before$strain == "blank"])

mi_before %>%
    # For this batch use the following strains
    #filter(strain %in% c("H2M3R2", "H3M1R1", "H3M3R2", "H3M4R1", "H4M5R1", "L1M2R2", "L2M2R1", "L4M2R2", "L4M3R3", "L4M4R1")) %>%
    filter(strain != "blank") %>% 
    mutate(od600 = od600 - od600_blank) %>% 
    arrange(column, row) %>% 
    mutate(od_dissolved = od600) %>%
    mutate(od_target = 0.1, volume_target = 100) %>% 
    mutate(volume_dissolved = round(volume_target * od_target / od_dissolved, 2)) %>%
    mutate(volume_pbs = round(volume_target - volume_dissolved, 2)) %>%
    select(strain, well, od_dissolved, od_target, volume_target, volume_dissolved, volume_pbs) %>% 
    kable()

```





\newpage














